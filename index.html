<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> FInance </title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, remove } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
        
        // Konfigurasi Firebase Anda
        const firebaseConfig = {
            // GANTI DENGAN KONFIGURASI FIREBASE ANDA
            apiKey: "AIzaSyC8D38fsurxvrhOOUmf0lObffBRBaUneDE",
            authDomain: "chat-9f7d2.firebaseapp.com",
            databaseURL: "https://chat-9f7d2-default-rtdb.firebaseio.com",
            projectId: "chat-9f7d2",
            storageBucket: "chat-9f7d2.firebasestorage.app",
            messagingSenderId: "1075402993095",
            appId: "1:1075402993095:web:d5a5c998e0c4dcdd20bde2"
        };
        
        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // Ekspor variabel untuk digunakan di script utama
        window.firebaseDatabase = database;
        window.firebaseRef = ref;
        window.firebasePush = push;
        window.firebaseSet = set;
        window.firebaseOnValue = onValue;
        window.firebaseRemove = remove;
    </script>
    
    <!-- Font Awesome untuk ikon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #3b82f6;
            --income-color: #10b981;
            --expense-color: #ef4444;
            --bg-light: #f9fafb;
            --bg-dark: #111827;
            --card-light: #ffffff;
            --card-dark: #1f2937;
            --text-light: #111827;
            --text-dark: #f9fafb;
        }
        
        body.dark-mode {
            background-color: var(--bg-dark);
            color: var(--text-dark);
        }
        
        body.light-mode {
            background-color: var(--bg-light);
            color: var(--text-light);
        }
        
        .card {
            background-color: var(--card-light);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        
        .dark-mode .card {
            background-color: var(--card-dark);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        
        .income {
            color: var(--income-color);
        }
        
        .expense {
            color: var(--expense-color);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        
        .btn-primary:hover {
            background-color: #2563eb;
        }
        
        .btn-success {
            background-color: var(--income-color);
            color: white;
        }
        
        .btn-danger {
            background-color: var(--expense-color);
            color: white;
        }
        
        .table-row-income {
            background-color: rgba(16, 185, 129, 0.1);
        }
        
        .dark-mode .table-row-income {
            background-color: rgba(16, 185, 129, 0.2);
        }
        
        .table-row-expense {
            background-color: rgba(239, 68, 68, 0.1);
        }
        
        .dark-mode .table-row-expense {
            background-color: rgba(239, 68, 68, 0.2);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            animation: slideIn 0.3s, fadeOut 0.3s 2.7s;
            animation-fill-mode: forwards;
            max-width: 300px;
        }
        
        .notification.success {
            background-color: var(--income-color);
        }
        
        .notification.error {
            background-color: var(--expense-color);
        }
        
        @keyframes slideIn {
            from { right: -350px; }
            to { right: 20px; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .stat-card {
                margin-bottom: 1rem;
            }
            
            .chart-container {
                height: 250px !important;
            }
            
            .table-container {
                overflow-x: auto;
            }
        }
    </style>
</head>
<body class="light-mode">
    <!-- Navigation -->
    <nav class="bg-white dark:bg-gray-800 shadow-lg py-4 px-6">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center">
                <i class="fas fa-wallet text-2xl mr-3 text-blue-500"></i>
                <h1 class="text-2xl font-bold">Lacy&Lucy</h1>
            </div>
            <div class="flex items-center space-x-4">
                <button id="themeToggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700">
                    <i class="fas fa-moon dark:hidden"></i>
                    <i class="fas fa-sun hidden dark:inline"></i>
                </button>
                <div class="text-sm">
                    <span id="currentDate"></span>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-6">
        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="card p-6 stat-card">
                <div class="flex items-center">
                    <div class="rounded-full bg-green-100 dark:bg-green-900 p-3 mr-4">
                        <i class="fas fa-arrow-down text-green-600 dark:text-green-300 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-gray-500 dark:text-gray-300 text-sm font-medium">Total Pemasukan</h3>
                        <p class="text-2xl font-bold income" id="totalIncome">Rp 0</p>
                    </div>
                </div>
            </div>
            
            <div class="card p-6 stat-card">
                <div class="flex items-center">
                    <div class="rounded-full bg-red-100 dark:bg-red-900 p-3 mr-4">
                        <i class="fas fa-arrow-up text-red-600 dark:text-red-300 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-gray-500 dark:text-gray-300 text-sm font-medium">Total Pengeluaran</h3>
                        <p class="text-2xl font-bold expense" id="totalExpense">Rp 0</p>
                    </div>
                </div>
            </div>
            
            <div class="card p-6 stat-card">
                <div class="flex items-center">
                    <div class="rounded-full bg-blue-100 dark:bg-blue-900 p-3 mr-4">
                        <i class="fas fa-balance-scale text-blue-600 dark:text-blue-300 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-gray-500 dark:text-gray-300 text-sm font-medium">Saldo Akhir</h3>
                        <p class="text-2xl font-bold" id="totalBalance">Rp 0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts and Input Form -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Charts Section -->
            <div>
                <div class="card p-6 mb-6">
                    <h2 class="text-xl font-bold mb-4">Grafik Keuangan Harian</h2>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="dailyChart"></canvas>
                    </div>
                </div>
                
                <div class="card p-6">
                    <h2 class="text-xl font-bold mb-4">Grafik Keuangan Bulanan</h2>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Input Form -->
            <div>
                <div class="card p-6">
                    <h2 class="text-xl font-bold mb-6">Tambah Transaksi</h2>
                    
                    <form id="transactionForm">
                        <div class="mb-4">
                            <label for="date" class="block mb-2 font-medium">Tanggal</label>
                            <input type="date" id="date" required
                                class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                        </div>
                        
                        <div class="mb-4">
                            <label for="type" class="block mb-2 font-medium">Jenis Transaksi</label>
                            <select id="type" required
                                class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                                <option value="pemasukan">Pemasukan</option>
                                <option value="pengeluaran">Pengeluaran</option>
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <label for="amount" class="block mb-2 font-medium">Nominal (Rp)</label>
                            <input type="text" id="amount" placeholder="0" required
                                class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                        </div>
                        
                        <div class="mb-6">
                            <label for="description" class="block mb-2 font-medium">Keterangan</label>
                            <textarea id="description" rows="3" placeholder="Deskripsi transaksi"
                                class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700"></textarea>
                        </div>
                        
                        <button type="submit" id="saveBtn" class="btn-primary w-full py-3 flex items-center justify-center">
                            <i class="fas fa-save mr-2"></i> Simpan Transaksi
                        </button>
                        
                        <div id="loading" class="loading">
                            <i class="fas fa-spinner fa-spin text-2xl text-blue-500"></i>
                            <p class="mt-2">Menyimpan data...</p>
                        </div>
                    </form>
                    
                    <!-- Filter Section -->
                    <div class="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                        <h3 class="font-medium mb-3">Filter Data</h3>
                        <div class="flex flex-wrap gap-2">
                            <button id="filterAll" class="px-4 py-2 rounded-lg bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">Semua</button>
                            <button id="filterIncome" class="px-4 py-2 rounded-lg bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200">Pemasukan</button>
                            <button id="filterExpense" class="px-4 py-2 rounded-lg bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200">Pengeluaran</button>
                            <button id="filterToday" class="px-4 py-2 rounded-lg bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200">Hari Ini</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transaction History -->
        <div class="card p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Riwayat Transaksi</h2>
                <div class="text-sm">
                    <span id="transactionCount">0 transaksi</span>
                </div>
            </div>
            
            <div class="table-container">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-gray-200 dark:border-gray-700">
                            <th class="py-3 text-left">Tanggal</th>
                            <th class="py-3 text-left">Jenis</th>
                            <th class="py-3 text-left">Nominal</th>
                            <th class="py-3 text-left">Keterangan</th>
                            <th class="py-3 text-left">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="transactionList">
                        <!-- Data akan dimuat di sini -->
                    </tbody>
                </table>
            </div>
            
            <div id="emptyState" class="text-center py-10">
                <i class="fas fa-receipt text-4xl text-gray-400 mb-4"></i>
                <p class="text-gray-500">Belum ada transaksi. Tambahkan transaksi pertama Anda!</p>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <script>
        // Variabel global
        let transactions = [];
        let currentFilter = 'all';
        let dailyChart, monthlyChart;
        
        // Format tanggal Indonesia
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
        }
        
        // Format mata uang Rupiah
        function formatRupiah(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }
        
        // Format input rupiah saat mengetik
        document.getElementById('amount').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value) {
                value = parseInt(value, 10);
                e.target.value = formatRupiah(value).replace('Rp', '').trim();
            } else {
                e.target.value = '';
            }
        });
        
        // Set tanggal default ke hari ini
        document.getElementById('date').valueAsDate = new Date();
        
        // Tampilkan tanggal hari ini
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString('id-ID', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        
        // Toggle tema dark/light
        document.getElementById('themeToggle').addEventListener('click', function() {
            if (document.body.classList.contains('light-mode')) {
                document.body.classList.remove('light-mode');
                document.body.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
            } else {
                document.body.classList.remove('dark-mode');
                document.body.classList.add('light-mode');
                localStorage.setItem('theme', 'light');
            }
            
            // Update chart tema
            if (dailyChart) {
                dailyChart.options.plugins.legend.labels.color = document.body.classList.contains('dark-mode') ? '#f9fafb' : '#111827';
                dailyChart.update();
            }
            if (monthlyChart) {
                monthlyChart.options.plugins.legend.labels.color = document.body.classList.contains('dark-mode') ? '#f9fafb' : '#111827';
                monthlyChart.update();
            }
        });
        
        // Load tema dari localStorage
        const savedTheme = localStorage.getItem('theme') || 'light';
        if (savedTheme === 'dark') {
            document.body.classList.remove('light-mode');
            document.body.classList.add('dark-mode');
        }
        
        // Fungsi untuk menampilkan notifikasi
        function showNotification(message, type = 'success') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
            
            container.appendChild(notification);
            
            // Hapus notifikasi setelah animasi selesai
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }
        
        // Fungsi untuk menghitung total
        function calculateTotals() {
            let totalIncome = 0;
            let totalExpense = 0;
            
            transactions.forEach(transaction => {
                if (transaction.type === 'pemasukan') {
                    totalIncome += transaction.amount;
                } else {
                    totalExpense += transaction.amount;
                }
            });
            
            const totalBalance = totalIncome - totalExpense;
            
            // Update UI
            document.getElementById('totalIncome').textContent = formatRupiah(totalIncome);
            document.getElementById('totalExpense').textContent = formatRupiah(totalExpense);
            document.getElementById('totalBalance').textContent = formatRupiah(totalBalance);
            
            // Update jumlah transaksi
            document.getElementById('transactionCount').textContent = `${transactions.length} transaksi`;
            
            return { totalIncome, totalExpense, totalBalance };
        }
        
        // Fungsi untuk memfilter transaksi
        function filterTransactions(filterType) {
            currentFilter = filterType;
            const today = new Date().toISOString().split('T')[0];
            
            let filteredTransactions = transactions;
            
            if (filterType === 'income') {
                filteredTransactions = transactions.filter(t => t.type === 'pemasukan');
            } else if (filterType === 'expense') {
                filteredTransactions = transactions.filter(t => t.type === 'pengeluaran');
            } else if (filterType === 'today') {
                filteredTransactions = transactions.filter(t => t.date === today);
            }
            
            renderTransactionList(filteredTransactions);
        }
        
        // Fungsi untuk merender daftar transaksi
        function renderTransactionList(transactionsToRender = transactions) {
            const transactionList = document.getElementById('transactionList');
            const emptyState = document.getElementById('emptyState');
            
            if (transactionsToRender.length === 0) {
                transactionList.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            // Urutkan dari yang terbaru
            transactionsToRender.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let html = '';
            transactionsToRender.forEach(transaction => {
                const rowClass = transaction.type === 'pemasukan' ? 'table-row-income' : 'table-row-expense';
                const typeText = transaction.type === 'pemasukan' ? 'Pemasukan' : 'Pengeluaran';
                const typeIcon = transaction.type === 'pemasukan' ? 'fa-arrow-down' : 'fa-arrow-up';
                const typeColor = transaction.type === 'pemasukan' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
                
                html += `
                    <tr class="${rowClass}">
                        <td class="py-3">${formatDate(transaction.date)}</td>
                        <td class="py-3">
                            <div class="flex items-center">
                                <i class="fas ${typeIcon} ${typeColor} mr-2"></i>
                                ${typeText}
                            </div>
                        </td>
                        <td class="py-3 font-medium ${transaction.type === 'pemasukan' ? 'income' : 'expense'}">
                            ${transaction.type === 'pemasukan' ? '+' : '-'} ${formatRupiah(transaction.amount)}
                        </td>
                        <td class="py-3">${transaction.description || '-'}</td>
                        <td class="py-3">
                            <button onclick="deleteTransaction('${transaction.id}')" class="text-red-500 hover:text-red-700">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            transactionList.innerHTML = html;
        }
        
        // Fungsi untuk menghapus transaksi
        window.deleteTransaction = function(transactionId) {
            if (!confirm('Apakah Anda yakin ingin menghapus transaksi ini?')) return;
            
            const transactionRef = window.firebaseRef(window.firebaseDatabase, `transactions/${transactionId}`);
            window.firebaseRemove(transactionRef)
                .then(() => {
                    showNotification('Transaksi berhasil dihapus', 'success');
                })
                .catch(error => {
                    console.error('Error deleting transaction:', error);
                    showNotification('Gagal menghapus transaksi', 'error');
                });
        };
        
        // Fungsi untuk mengupdate grafik
        function updateCharts() {
            const { totalIncome, totalExpense } = calculateTotals();
            
            // Data harian (7 hari terakhir)
            const last7Days = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                last7Days.push(date.toISOString().split('T')[0]);
            }
            
            const dailyIncome = [];
            const dailyExpense = [];
            
            last7Days.forEach(day => {
                const dayTransactions = transactions.filter(t => t.date === day);
                const dayIncome = dayTransactions
                    .filter(t => t.type === 'pemasukan')
                    .reduce((sum, t) => sum + t.amount, 0);
                const dayExpense = dayTransactions
                    .filter(t => t.type === 'pengeluaran')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                dailyIncome.push(dayIncome);
                dailyExpense.push(dayExpense);
            });
            
            // Format label tanggal untuk grafik harian
            const dailyLabels = last7Days.map(date => {
                const d = new Date(date);
                return d.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
            });
            
            // Data bulanan (6 bulan terakhir)
            const last6Months = [];
            for (let i = 5; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                last6Months.push({
                    year: date.getFullYear(),
                    month: date.getMonth()
                });
            }
            
            const monthlyIncome = [];
            const monthlyExpense = [];
            
            last6Months.forEach(({ year, month }) => {
                const monthTransactions = transactions.filter(t => {
                    const transactionDate = new Date(t.date);
                    return transactionDate.getFullYear() === year && 
                           transactionDate.getMonth() === month;
                });
                
                const monthIncome = monthTransactions
                    .filter(t => t.type === 'pemasukan')
                    .reduce((sum, t) => sum + t.amount, 0);
                const monthExpense = monthTransactions
                    .filter(t => t.type === 'pengeluaran')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                monthlyIncome.push(monthIncome);
                monthlyExpense.push(monthExpense);
            });
            
            // Format label bulan untuk grafik bulanan
            const monthlyLabels = last6Months.map(({ year, month }) => {
                const date = new Date(year, month);
                return date.toLocaleDateString('id-ID', { month: 'short', year: 'numeric' });
            });
            
            // Warna berdasarkan tema
            const textColor = document.body.classList.contains('dark-mode') ? '#f9fafb' : '#111827';
            const gridColor = document.body.classList.contains('dark-mode') ? '#374151' : '#e5e7eb';
            
            // Grafik Harian
            const dailyCtx = document.getElementById('dailyChart').getContext('2d');
            
            if (dailyChart) {
                dailyChart.data.labels = dailyLabels;
                dailyChart.data.datasets[0].data = dailyIncome;
                dailyChart.data.datasets[1].data = dailyExpense;
                dailyChart.options.plugins.legend.labels.color = textColor;
                dailyChart.options.scales.x.grid.color = gridColor;
                dailyChart.options.scales.y.grid.color = gridColor;
                dailyChart.options.scales.x.ticks.color = textColor;
                dailyChart.options.scales.y.ticks.color = textColor;
                dailyChart.update();
            } else {
                dailyChart = new Chart(dailyCtx, {
                    type: 'bar',
                    data: {
                        labels: dailyLabels,
                        datasets: [
                            {
                                label: 'Pemasukan',
                                data: dailyIncome,
                                backgroundColor: '#10b981',
                                borderRadius: 6
                            },
                            {
                                label: 'Pengeluaran',
                                data: dailyExpense,
                                backgroundColor: '#ef4444',
                                borderRadius: 6
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: textColor
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: gridColor
                                },
                                ticks: {
                                    color: textColor
                                }
                            },
                            y: {
                                grid: {
                                    color: gridColor
                                },
                                ticks: {
                                    color: textColor,
                                    callback: function(value) {
                                        if (value >= 1000000) {
                                            return 'Rp' + (value / 1000000).toFixed(1) + 'Jt';
                                        } else if (value >= 1000) {
                                            return 'Rp' + (value / 1000).toFixed(0) + 'Rb';
                                        }
                                        return 'Rp' + value;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Grafik Bulanan
            const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
            
            if (monthlyChart) {
                monthlyChart.data.labels = monthlyLabels;
                monthlyChart.data.datasets[0].data = monthlyIncome;
                monthlyChart.data.datasets[1].data = monthlyExpense;
                monthlyChart.options.plugins.legend.labels.color = textColor;
                monthlyChart.options.scales.x.grid.color = gridColor;
                monthlyChart.options.scales.y.grid.color = gridColor;
                monthlyChart.options.scales.x.ticks.color = textColor;
                monthlyChart.options.scales.y.ticks.color = textColor;
                monthlyChart.update();
            } else {
                monthlyChart = new Chart(monthlyCtx, {
                    type: 'line',
                    data: {
                        labels: monthlyLabels,
                        datasets: [
                            {
                                label: 'Pemasukan',
                                data: monthlyIncome,
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                fill: true,
                                tension: 0.4
                            },
                            {
                                label: 'Pengeluaran',
                                data: monthlyExpense,
                                borderColor: '#ef4444',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                fill: true,
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: textColor
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: gridColor
                                },
                                ticks: {
                                    color: textColor
                                }
                            },
                            y: {
                                grid: {
                                    color: gridColor
                                },
                                ticks: {
                                    color: textColor,
                                    callback: function(value) {
                                        if (value >= 1000000) {
                                            return 'Rp' + (value / 1000000).toFixed(1) + 'Jt';
                                        } else if (value >= 1000) {
                                            return 'Rp' + (value / 1000).toFixed(0) + 'Rb';
                                        }
                                        return 'Rp' + value;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }
        
        // Fungsi untuk menyimpan transaksi ke Firebase
        async function saveTransaction(transactionData) {
            try {
                // Tampilkan loading
                document.getElementById('loading').style.display = 'block';
                document.getElementById('saveBtn').disabled = true;
                
                // Simpan ke Firebase
                const transactionsRef = window.firebaseRef(window.firebaseDatabase, 'transactions');
                const newTransactionRef = window.firebasePush(transactionsRef);
                
                await window.firebaseSet(newTransactionRef, {
                    ...transactionData,
                    timestamp: Date.now()
                });
                
                showNotification('Transaksi berhasil disimpan!', 'success');
                
                // Reset form
                document.getElementById('transactionForm').reset();
                document.getElementById('date').valueAsDate = new Date();
                
                return true;
            } catch (error) {
                console.error('Error saving transaction:', error);
                showNotification('Gagal menyimpan transaksi. Coba lagi.', 'error');
                return false;
            } finally {
                // Sembunyikan loading
                document.getElementById('loading').style.display = 'none';
                document.getElementById('saveBtn').disabled = false;
            }
        }
        
        // Event listener untuk form submit
        document.getElementById('transactionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Validasi input
            const date = document.getElementById('date').value;
            const type = document.getElementById('type').value;
            const amountInput = document.getElementById('amount').value;
            const description = document.getElementById('description').value;
            
            if (!date || !type || !amountInput) {
                showNotification('Harap isi semua bidang yang wajib!', 'error');
                return;
            }
            
            // Parse nominal dari format Rupiah
            const amount = parseInt(amountInput.replace(/[^\d]/g, ''), 10);
            
            if (isNaN(amount) || amount <= 0) {
                showNotification('Nominal harus lebih dari 0!', 'error');
                return;
            }
            
            // Simpan transaksi
            const transactionData = {
                date,
                type,
                amount,
                description: description || ''
            };
            
            await saveTransaction(transactionData);
        });
        
        // Event listener untuk filter
        document.getElementById('filterAll').addEventListener('click', () => filterTransactions('all'));
        document.getElementById('filterIncome').addEventListener('click', () => filterTransactions('income'));
        document.getElementById('filterExpense').addEventListener('click', () => filterTransactions('expense'));
        document.getElementById('filterToday').addEventListener('click', () => filterTransactions('today'));
        
        // Load data dari Firebase
        function loadTransactions() {
            const transactionsRef = window.firebaseRef(window.firebaseDatabase, 'transactions');
            
            window.firebaseOnValue(transactionsRef, (snapshot) => {
                transactions = [];
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    
                    // Konversi data Firebase ke array
                    Object.keys(data).forEach(key => {
                        transactions.push({
                            id: key,
                            ...data[key]
                        });
                    });
                }
                
                // Update UI
                calculateTotals();
                renderTransactionList();
                updateCharts();
            }, (error) => {
                console.error('Error loading transactions:', error);
                showNotification('Gagal memuat data transaksi', 'error');
            });
        }
        
        // Inisialisasi aplikasi
        document.addEventListener('DOMContentLoaded', function() {
            // Tunggu Firebase siap
            setTimeout(() => {
                if (window.firebaseDatabase) {
                    loadTransactions();
                } else {
                    showNotification('Firebase belum dikonfigurasi. Harap perbarui konfigurasi Firebase.', 'error');
                }
            }, 1000);
        });
    </script>
</body>
</html>